
Файл ProjectApplication.java
package com.uni.project;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ProjectApplication {

    public static void main(String[] args) {
        SpringApplication.run(ProjectApplication.class, args);
    }

}


Файл MealController.java
package com.uni.project.controller;

import com.uni.project.model.dto.request.MealRequest;
import com.uni.project.model.dto.response.MealResponse;
import com.uni.project.service.MealService;
import jakarta.validation.Valid;
import lombok.AllArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("/api/meal")
@AllArgsConstructor
public class MealController {
    private final MealService mealService;

    @GetMapping("/{id}")
    public ResponseEntity<MealResponse>  getMealById(@PathVariable Integer id) {
        return ResponseEntity.ok(mealService.getMealById(id));
    }

    @GetMapping
    public ResponseEntity<List<MealResponse>> getAllMeals() {
        return ResponseEntity.ok(mealService.getAllMeals());
    }
    
    @PostMapping
    public ResponseEntity<MealResponse> mealCreate(@Valid @RequestBody MealRequest mealRequest) {
        return ResponseEntity.status(HttpStatus.CREATED).body(mealService.mealCreate(mealRequest));
    }

    @PutMapping("/{id}")
    public ResponseEntity<MealResponse> mealUpdate(@PathVariable Integer id,
                                                   @Valid @RequestBody MealRequest mealRequest) {
        return ResponseEntity.ok(mealService.mealUpdate(id, mealRequest));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> mealDelete(@PathVariable Integer id) {
        mealService.mealDelete(id);
        return ResponseEntity.noContent().build();
    }

    @GetMapping("/name")
    public ResponseEntity<List<MealResponse>> getAllMealsByName(@RequestParam String nameSearch) {
        return ResponseEntity.ok(mealService.getAllMealsByName(nameSearch));
    }

    @GetMapping("/author")
    public ResponseEntity<List<MealResponse>> getAllMealsByAuthor(@RequestParam("authorId") Integer authorId) {
        return ResponseEntity.ok(mealService.getAllMealsByAuthorId(authorId));
    }

    @GetMapping("/product_list")
    public ResponseEntity<List<MealResponse>> getAllMealsByProductList(
            @RequestParam("productIds") List<Integer> productIds) {
        return ResponseEntity.ok(mealService.getAllMealsByProductIds(productIds));
    }
}


Файл NoteController.java
package com.uni.project.controller;

import com.uni.project.model.dto.request.NoteRequest;
import com.uni.project.model.dto.response.NoteResponse;
import com.uni.project.service.NoteService;
import jakarta.validation.Valid;
import lombok.AllArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDate;
import java.util.List;

@RestController
@RequestMapping("/api/note")
@AllArgsConstructor
public class NoteController {
    private final NoteService noteService;

    @PostMapping
    public ResponseEntity<NoteResponse> noteCreate(@Valid @RequestBody NoteRequest noteRequest) {
        return ResponseEntity.status(HttpStatus.CREATED).body(noteService.noteCreate(noteRequest));
    }

    @GetMapping("/{id}")
    public ResponseEntity<NoteResponse> getNoteById(@PathVariable Integer id) {
        return ResponseEntity.ok(noteService.getNoteById(id));
    }

    @GetMapping
    public ResponseEntity<List<NoteResponse>> getAllNotes() {
        return ResponseEntity.ok(noteService.getAllNotes());
    }

    @PutMapping("/{id}")
    public ResponseEntity<NoteResponse> noteUpdate(@PathVariable Integer id,
                                                   @Valid @RequestBody NoteRequest noteRequest) {
        return ResponseEntity.ok(noteService.noteUpdate(id, noteRequest));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> noteDelete(@PathVariable Integer id) {
        noteService.noteDelete(id);
        return ResponseEntity.noContent().build();
    }

    @GetMapping("/date")
    public ResponseEntity<List<NoteResponse>> getAllNotesByDate(@RequestParam LocalDate dateSearch) {
        return ResponseEntity.ok(noteService.getAllNotesByDate(dateSearch));
    }

    @GetMapping("/meal_note")
    public ResponseEntity<List<NoteResponse>> getAllNotesByMeal(@RequestParam("mealId") Integer mealId) {
        return ResponseEntity.ok(noteService.getAllNotesByMealId(mealId));
    }
}


Файл ProductController.java
package com.uni.project.controller;

import com.uni.project.model.dto.request.ProductRequest;
import com.uni.project.model.dto.response.ProductResponse;
import com.uni.project.service.ProductService;
import jakarta.validation.Valid;
import lombok.AllArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("/api/products")
@AllArgsConstructor
public class ProductController {
    private final ProductService productService;

    @GetMapping("/{id}")
    public ResponseEntity<ProductResponse> getProductById(@PathVariable Integer id) {
        return ResponseEntity.ok(productService.getProductById(id));
    }

    @GetMapping
    public ResponseEntity<List<ProductResponse>> getAllProducts() {
        return ResponseEntity.ok(productService.getAllProducts());
    }

    @PostMapping
    public ResponseEntity<ProductResponse> productCreate(@Valid @RequestBody
                                                         ProductRequest productRequest) {
        return ResponseEntity.status(HttpStatus.CREATED).body(productService.productCreate(productRequest));
    }

    @PutMapping("/{id}")
    public ResponseEntity<ProductResponse> productUpdate(@PathVariable Integer id,
                                                         @Valid @RequestBody ProductRequest productRequest) {
        return ResponseEntity.ok(productService.productUpdate(id, productRequest));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> productDelete(@PathVariable Integer id) {
        productService.productDelete(id);
        return ResponseEntity.noContent().build();
    }

    @GetMapping("/name")
    public ResponseEntity<List<ProductResponse>> getAllProductsByName(@RequestParam String nameSearch) {
        return ResponseEntity.ok(productService.getAllProductsByName(nameSearch));
    }

    @GetMapping("/meal_list")
    public ResponseEntity<List<ProductResponse>> getAllProductsByMeal(@RequestParam("mealId") Integer mealId) {
        return ResponseEntity.ok(productService.getAllProductsByMealId(mealId));
    }
}


Файл UserController.java
package com.uni.project.controller;

import com.uni.project.model.dto.request.UserCompositeRequest;
import com.uni.project.model.dto.request.UserMeasurementsRequest;
import com.uni.project.model.dto.request.UserRequest;
import com.uni.project.model.dto.response.NutritionalValueResponse;
import com.uni.project.model.dto.response.UserResponse;
import com.uni.project.model.entity.Sex;
import com.uni.project.service.UserService;
import jakarta.validation.Valid;
import lombok.AllArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("/api/users")
@AllArgsConstructor
public class UserController {
    private final UserService userService;

    @GetMapping("/{id}")
    public ResponseEntity<UserResponse> getUserById(@PathVariable Integer id){
        return ResponseEntity.ok(userService.getUserById(id));
    }

    @GetMapping
    public ResponseEntity<List<UserResponse>> getAllUsers(){
        return ResponseEntity.ok(userService.getAllUsers());
    }

    @PostMapping
    public ResponseEntity<UserResponse> userCreate(@Valid @RequestBody UserRequest userRequest){
        return ResponseEntity.status(HttpStatus.CREATED).body(userService.userCreate(userRequest));
    }

    @PutMapping("/{id}")
    public ResponseEntity<UserResponse> userUpdate(@PathVariable Integer id,
                                                   @Valid @RequestBody UserRequest userRequest){
        return ResponseEntity.ok(userService.userUpdate(id, userRequest));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> userDelete(@PathVariable Integer id){
        userService.userDelete(id);

        return ResponseEntity.noContent().build();
    }

    @PutMapping("/{id}/measurements")
    public ResponseEntity<UserResponse> measurementsUpdate(@PathVariable Integer id,
                                                           @Valid @RequestBody UserMeasurementsRequest userRequest){
        return ResponseEntity.ok(userService.measurementsUpdate(id, userRequest));
    }

    @GetMapping("/name")
    public ResponseEntity<List<UserResponse>> getAllUsersByName(@RequestParam String nameSearch) {
        return ResponseEntity.ok(userService.getAllUsersByName(nameSearch));
    }

    @GetMapping("/sex")
    public ResponseEntity<List<UserResponse>> getAllUsersBySex(@RequestParam Sex sexSearch) {
        return ResponseEntity.ok(userService.getAllUsersBySex(sexSearch));
    }

    @GetMapping("/age")
    public ResponseEntity<List<UserResponse>>  getAllUsersByAge(@RequestParam Integer ageSearch) {
        return ResponseEntity.ok(userService.getAllUsersByAge(ageSearch));
    }

    @PostMapping("/{id}/nutritional")
    public ResponseEntity<NutritionalValueResponse> calculateNutritionalValueForUser(@PathVariable Integer id) {
        return ResponseEntity.ok(userService.calculateNutritionalValueForUser(id));
    }

    @GetMapping("/with-meals")
    public ResponseEntity<List<UserResponse>> findAllWithMeals() {
        return ResponseEntity.ok(userService.findAllWithMeals());
    }

    @PostMapping("/without_transaction")
    public ResponseEntity<UserResponse> createUserWithGoalAndNoteNoTx(
            @Valid @RequestBody UserCompositeRequest userRequest) {
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(userService.createUserWithGoalAndNoteNoTx(userRequest));
    }

    @PostMapping("/with_transaction")
    public ResponseEntity<UserResponse> createUserWithGoalAndNoteTx(
            @Valid @RequestBody UserCompositeRequest userRequest) {
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(userService.createUserWithGoalAndNoteTx(userRequest));
    }
}


Файл MealException.java
package com.uni.project.exception;

public class MealException extends RuntimeException {
    public MealException(String message) {
        super(message);
    }
}


Файл NoteException.java
package com.uni.project.exception;

public class NoteException extends RuntimeException {
    public NoteException(String message) {
        super(message);
    }
}


Файл ProductException.java
package com.uni.project.exception;

public class ProductException extends RuntimeException {
    public ProductException(String message) {
        super(message);
    }
}


Файл UserException.java
package com.uni.project.exception;

public class UserException extends RuntimeException {
    public UserException(String message) {
        super(message);
    }
}


Файл MealMapper.java
package com.uni.project.mapper;

import com.uni.project.model.dto.request.MealRequest;
import com.uni.project.model.dto.response.MealResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Product;
import com.uni.project.model.entity.User;
import java.util.List;
import java.util.Objects;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.Named;

@Mapper(componentModel = "spring", uses = NutritionalValueMapper.class)
public interface MealMapper {
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "name", source = "mealRequest.name")
    @Mapping(target = "date", source = "mealRequest.date")
    @Mapping(target = "totalNutritional", source = "mealRequest.totalNutritional")
    @Mapping(target = "author", source = "author")
    @Mapping(target = "productList", ignore = true)
    @Mapping(target = "recipe", ignore = true)
    Meal fromRequest(MealRequest mealRequest, User author);

    @Mapping(target = "authorId", source = "author.id")
    @Mapping(target = "productIds", source = "productList", qualifiedByName = "mapProductIds")
    @Mapping(target = "recipeId", source = "recipe.id")
    MealResponse toResponse(Meal meal);

    List<MealResponse> toResponses(List<Meal> meals);

    @Named("mapProductIds")
    default List<Integer> mapProductIds(List<Product> products) {
        if (products == null || products.isEmpty()) {
            return List.of();
        }
        return products.stream()
                .filter(Objects::nonNull)
                .map(Product::getId)
                .filter(Objects::nonNull)
                .toList();
    }
}


Файл NoteMapper.java
package com.uni.project.mapper;

import com.uni.project.model.dto.request.NoteRequest;
import com.uni.project.model.dto.response.NoteResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Note;
import java.util.List;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

@Mapper(componentModel = "spring")
public interface NoteMapper {
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "meal", source = "meal")
    Note fromRequest(NoteRequest noteRequest, Meal meal);

    @Mapping(target = "mealId", source = "meal.id")
    NoteResponse toResponse(Note note);

    List<NoteResponse> toResponses(List<Note> notes);
}


Файл NutritionalValueMapper.java
package com.uni.project.mapper;

import com.uni.project.model.dto.request.NutritionalValueRequest;
import com.uni.project.model.dto.response.NutritionalValueResponse;
import com.uni.project.model.entity.NutritionalValue;
import java.util.List;
import org.mapstruct.Mapper;

@Mapper(componentModel = "spring")
public interface NutritionalValueMapper {
    NutritionalValueResponse toResponse(NutritionalValue nutritionalValue);

    List<NutritionalValueResponse> toResponses(List<NutritionalValue> values);

    NutritionalValue fromRequest(NutritionalValueRequest nutritionalValueRequest);
}


Файл ProductMapper.java
package com.uni.project.mapper;

import com.uni.project.model.dto.request.ProductRequest;
import com.uni.project.model.dto.response.ProductResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Product;
import java.util.List;
import java.util.Objects;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.Named;

@Mapper(componentModel = "spring", uses = NutritionalValueMapper.class)
public interface ProductMapper {
    @Mapping(target = "mealIds", source = "mealList", qualifiedByName = "mapMealIds")
    ProductResponse toResponse(Product product);

    List<ProductResponse> toResponses(List<Product> products);

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "mealList", source = "meals")
    Product fromRequest(ProductRequest productRequest, List<Meal> meals);

    @Named("mapMealIds")
    default List<Integer> mapMealIds(List<Meal> meals) {
        if (meals == null || meals.isEmpty()) {
            return List.of();
        }
        return meals.stream()
                .filter(Objects::nonNull)
                .map(Meal::getId)
                .filter(Objects::nonNull)
                .toList();
    }
}


Файл UserMapper.java
package com.uni.project.mapper;

import com.uni.project.model.dto.request.UserRequest;
import com.uni.project.model.dto.response.UserResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.User;
import java.util.List;
import java.util.Objects;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.Named;

@Mapper(componentModel = "spring", uses = NutritionalValueMapper.class)
public interface UserMapper {
    @Mapping(target = "mealIds", source = "mealsPlan", qualifiedByName = "mapMealIds")
    UserResponse toResponse(User user);

    List<UserResponse> toResponses(List<User> users);

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "mealsPlan", ignore = true)
    User fromRequest(UserRequest userRequest);

    @Named("mapMealIds")
    default List<Integer> mapMealIds(List<Meal> meals) {
        if (meals == null || meals.isEmpty()) {
            return List.of();
        }
        return meals.stream()
                .filter(Objects::nonNull)
                .map(Meal::getId)
                .filter(Objects::nonNull)
                .toList();
    }

}


Файл MealRequest.java
package com.uni.project.model.dto.request;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.time.LocalDate;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class MealRequest {
    @NotBlank
    private String name;

    @NotNull
    private LocalDate date;

    @Valid
    private NutritionalValueRequest totalNutritional;

    private Integer authorId;
}


Файл NoteRequest.java
package com.uni.project.model.dto.request;

import jakarta.validation.constraints.NotEmpty;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class NoteRequest {
    @NotNull
    private Integer mealId;

    @NotEmpty
    private List<String> notes;
}


Файл NutritionalValueRequest.java
package com.uni.project.model.dto.request;

import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.PositiveOrZero;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class NutritionalValueRequest {
    @NotNull
    @PositiveOrZero
    private Double calories;

    @NotNull
    @PositiveOrZero
    private Double proteins;

    @NotNull
    @PositiveOrZero
    private Double fats;

    @NotNull
    @PositiveOrZero
    private Double carbohydrates;
}


Файл ProductRequest.java
package com.uni.project.model.dto.request;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class ProductRequest {
    @NotBlank
    private String name;

    @NotNull
    @Valid
    private NutritionalValueRequest nutritionalValue100g;

    private List<Integer> mealIds;
}


Файл UserCompositeRequest.java
package com.uni.project.model.dto.request;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;
import java.time.LocalDate;
import java.util.List;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class UserCompositeRequest extends UserRequest {
    @Override
    @NotNull
    @Valid
    public NutritionalValueRequest getDailyGoal() {
        return super.getDailyGoal();
    }

    @NotNull
    private LocalDate noteDate;

    @NotNull
    private List<String> noteTexts;

    private boolean failAfterUser;
}


Файл UserMeasurementsRequest.java
package com.uni.project.model.dto.request;

import com.uni.project.model.entity.BodyParameters;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class UserMeasurementsRequest {
    @NotNull
    @Valid
    private BodyParameters measurements;
}


Файл UserRequest.java
package com.uni.project.model.dto.request;

import com.uni.project.model.entity.BodyParameters;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class UserRequest {
    @NotBlank
    private String name;

    @NotBlank
    private String password;

    @NotBlank
    @Email
    private String email;

    @NotNull
    @Valid
    private BodyParameters measurements;

    @Valid
    private NutritionalValueRequest dailyGoal;
}


Файл MealResponse.java
package com.uni.project.model.dto.response;

import java.time.LocalDate;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class MealResponse {
    private Integer id;

    private String name;

    private LocalDate date;

    private NutritionalValueResponse totalNutritional;

    private Integer authorId;

    private List<Integer> productIds;

    private Integer recipeId;
}


Файл NoteResponse.java
package com.uni.project.model.dto.response;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class NoteResponse {
    private Integer id;

    private Integer mealId;

    private List<String> notes;
}


Файл NutritionalValueResponse.java
package com.uni.project.model.dto.response;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class NutritionalValueResponse {
    private Double calories;

    private Double proteins;

    private Double fats;

    private Double carbohydrates;
}


Файл ProductResponse.java
package com.uni.project.model.dto.response;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class ProductResponse {
    private Integer id;

    private String name;

    private NutritionalValueResponse nutritionalValue100g;

    private List<Integer> mealIds;
}


Файл UserResponse.java
package com.uni.project.model.dto.response;

import com.uni.project.model.entity.BodyParameters;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class UserResponse {
    private Integer id;

    private String name;

    private String email;

    private BodyParameters measurements;

    private NutritionalValueResponse dailyGoal;

    private List<Integer> mealIds;
}


Файл BodyParameters.java
package com.uni.project.model.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;
import jakarta.validation.constraints.PositiveOrZero;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Embeddable
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class BodyParameters {
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    @NotNull
    private Sex sex;

    @Column
    @NotNull
    @Positive
    private Double weight;

    @Column
    @NotNull
    @Positive
    private Double height;

    @Column
    @NotNull
    @Positive
    private Integer age;

    @Column
    @PositiveOrZero
    private Double chest;

    @Column
    @PositiveOrZero
    private Double waist;

    @Column
    @PositiveOrZero
    private Double hips;
}


Файл Meal.java
package com.uni.project.model.entity;

import jakarta.persistence.CascadeType;
import jakarta.persistence.AttributeOverride;
import jakarta.persistence.AttributeOverrides;
import jakarta.persistence.Column;
import jakarta.persistence.Embedded;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToMany;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.PreRemove;
import jakarta.persistence.OneToOne;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
public class Meal {
    @EqualsAndHashCode.Include
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column
    private Integer id;

    @Column(nullable = false, length = 50)
    private String name;

    @Column
    private LocalDate date;

    @Embedded
    @AttributeOverrides({
            @AttributeOverride(name = "calories", column = @Column(name = "total_calories")),
            @AttributeOverride(name = "proteins", column = @Column(name = "total_proteins")),
            @AttributeOverride(name = "fats", column = @Column(name = "total_fats")),
            @AttributeOverride(name = "carbohydrates", column = @Column(name = "total_carbohydrates"))
    })
    private NutritionalValue totalNutritional;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn
    private User author;

    @ManyToMany(mappedBy = "mealList", fetch = FetchType.LAZY)
    private List<Product> productList;

    @OneToOne(cascade = CascadeType.ALL, orphanRemoval = true)
    @JoinColumn
    private Note recipe;

    @PreRemove
    private void unlinkProducts() {
        if (productList == null) {
            return;
        }
        for (Product product : new ArrayList<>(productList)) {
            if (product.getMealList() != null) {
                product.getMealList().remove(this);
            }
        }
        productList.clear();
    }
}


Файл Note.java
package com.uni.project.model.entity;

import jakarta.persistence.Column;
import jakarta.persistence.CollectionTable;
import jakarta.persistence.ElementCollection;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.OneToOne;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Entity
@Table
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
public class Note {
    @EqualsAndHashCode.Include
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column
    private Integer id;

    @OneToOne(mappedBy = "recipe", fetch = FetchType.EAGER)
    private Meal meal;

    @ElementCollection
    @CollectionTable(
            name = "note_notes",
            joinColumns = @JoinColumn(name = "note_id")
    )
    @Column(name = "note_text", nullable = false)
    private List<String> notes;
}


Файл NutritionalValue.java
package com.uni.project.model.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Embeddable
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class NutritionalValue {
    @Column(nullable = false)
    private Double calories;

    @Column(nullable = false)
    private Double proteins;

    @Column(nullable = false)
    private Double fats;

    @Column(nullable = false)
    private Double carbohydrates;
}


Файл Product.java
package com.uni.project.model.entity;

import jakarta.persistence.Column;
import jakarta.persistence.AttributeOverride;
import jakarta.persistence.AttributeOverrides;
import jakarta.persistence.Embedded;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.JoinTable;
import jakarta.persistence.ManyToMany;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Entity
@Table(name = "products")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
public class Product {
    @EqualsAndHashCode.Include
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Integer id;

    @Column(name = "name", nullable = false, length = 50)
    private String name;

    @Embedded
    @AttributeOverrides({
            @AttributeOverride(name = "calories", column = @Column(name = "nv100_calories")),
            @AttributeOverride(name = "proteins", column = @Column(name = "nv100_proteins")),
            @AttributeOverride(name = "fats", column = @Column(name = "nv100_fats")),
            @AttributeOverride(name = "carbohydrates", column = @Column(name = "nv100_carbohydrates"))
    })
    private NutritionalValue nutritionalValue100g;

    @ManyToMany
    @JoinTable(
            name = "meals_lists",
            joinColumns = @JoinColumn(name = "product_id"),
            inverseJoinColumns = @JoinColumn(name = "meal_id")
    )
    private List<Meal> mealList;
}


Файл Sex.java
package com.uni.project.model.entity;

public enum Sex {
    FEMALE,
    MALE
}


Файл User.java
package com.uni.project.model.entity;

import jakarta.persistence.CascadeType;
import jakarta.persistence.AttributeOverride;
import jakarta.persistence.AttributeOverrides;
import jakarta.persistence.Column;
import jakarta.persistence.Embedded;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.OneToMany;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

@Entity
@Table(name="users")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
public class User {
    @EqualsAndHashCode.Include
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Integer id;

    @Column(name = "name", nullable = false, length = 50)
    private String name;

    @Column(name = "password", nullable = false, length = 50)
    private String password;

    @Column(name = "email", nullable = false, length = 50)
    private String email;

    @Embedded
    private BodyParameters measurements;

    @Embedded
    @AttributeOverrides({
            @AttributeOverride(name = "calories", column = @Column(name = "daily_goal_calories")),
            @AttributeOverride(name = "proteins", column = @Column(name = "daily_goal_proteins")),
            @AttributeOverride(name = "fats", column = @Column(name = "daily_goal_fats")),
            @AttributeOverride(name = "carbohydrates", column = @Column(name = "daily_goal_carbohydrates"))
    })
    private NutritionalValue dailyGoal;

    @OneToMany(mappedBy = "author", fetch = FetchType.LAZY, cascade = CascadeType.REMOVE)
    private List<Meal> mealsPlan;
}


Файл MealRepository.java
package com.uni.project.repository;

import com.uni.project.model.entity.Meal;
import java.util.List;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

@Repository
public interface MealRepository extends JpaRepository<Meal, Integer> {
    List<Meal> findAllByName(String name);

    @Query("select m from Meal m where m.author.id = :authorId")
    List<Meal> findAllByAuthorId(@Param("authorId") Integer authorId);

    @Query("select distinct m from Meal m join m.productList p where p.id in :productIds")
    List<Meal> findAllByProductIds(@Param("productIds") List<Integer> productIds);
}


Файл NoteRepository.java
package com.uni.project.repository;

import com.uni.project.model.entity.Note;
import java.time.LocalDate;
import java.util.List;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

@Repository
public interface NoteRepository extends JpaRepository<Note, Integer> {
    @Query("select n from Note n where n.meal.date = :date")
    List<Note> findAllByDate(@Param("date") LocalDate date);

    @Query("select n from Note n where n.meal.id = :mealId")
    List<Note> findAllByMealId(@Param("mealId") Integer mealId);
}


Файл ProductRepository.java
package com.uni.project.repository;

import com.uni.project.model.entity.Product;
import java.util.List;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

@Repository
public interface ProductRepository extends JpaRepository<Product, Integer> {
    List<Product> findAllByName(String name);

    @Query("select distinct p from Product p join p.mealList m where m.id = :mealId")
    List<Product> findAllByMealId(@Param("mealId") Integer mealId);
}


Файл UserRepository.java
package com.uni.project.repository;

import com.uni.project.model.entity.User;
import com.uni.project.model.entity.Sex;
import java.util.List;
import org.jspecify.annotations.NullMarked;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<User, Integer> {
    List<User> findAllByName(String name);

    @Query("select u from User u where u.measurements.sex = :sex")
    List<User> findAllBySex(@Param("sex") Sex sex);

    @Query("select u from User u where u.measurements.age = :age")
    List<User> findAllByAge(@Param("age") Integer age);

    @Query("SELECT DISTINCT users FROM User users LEFT JOIN FETCH users.mealsPlan")
    List<User> findAllWithMeals();

    @Override
    @EntityGraph(attributePaths = {"mealsPlan", "mealsPlan.recipe"})
    @NullMarked
    List<User> findAll();
}


Файл MealService.java
package com.uni.project.service;

import com.uni.project.model.dto.request.MealRequest;
import com.uni.project.model.dto.response.MealResponse;

import java.util.List;

public interface MealService {
    MealResponse mealCreate(MealRequest mealRequest);

    MealResponse getMealById(Integer id);

    List<MealResponse> getAllMeals();

    MealResponse mealUpdate(Integer id, MealRequest mealRequest);

    void mealDelete(Integer id);

    List<MealResponse> getAllMealsByName(String nameSearch);

    List<MealResponse> getAllMealsByAuthorId(Integer authorId);

    List<MealResponse> getAllMealsByProductIds(List<Integer> productIds);
}


Файл NoteService.java
package com.uni.project.service;

import com.uni.project.model.dto.request.NoteRequest;
import com.uni.project.model.dto.response.NoteResponse;

import java.time.LocalDate;
import java.util.List;

public interface NoteService {
    NoteResponse noteCreate(NoteRequest noteRequest);

    NoteResponse getNoteById(Integer id);

    List<NoteResponse> getAllNotes();

    NoteResponse noteUpdate(Integer id, NoteRequest noteRequest);

    void noteDelete(Integer id);

    List<NoteResponse> getAllNotesByDate(LocalDate dateSearch);

    List<NoteResponse> getAllNotesByMealId(Integer mealId);
}


Файл ProductService.java
package com.uni.project.service;

import com.uni.project.model.dto.request.ProductRequest;
import com.uni.project.model.dto.response.ProductResponse;

import java.util.List;

public interface ProductService {
    ProductResponse productCreate(ProductRequest productRequest);

    ProductResponse getProductById(Integer id);

    List<ProductResponse> getAllProducts();

    ProductResponse productUpdate(Integer id, ProductRequest productRequest);

    void productDelete(Integer id);

    List<ProductResponse> getAllProductsByName(String nameSearch);

    List<ProductResponse> getAllProductsByMealId(Integer mealId);
}


Файл UserService.java
package com.uni.project.service;

import com.uni.project.model.dto.request.UserRequest;
import com.uni.project.model.dto.request.UserCompositeRequest;
import com.uni.project.model.dto.request.UserMeasurementsRequest;
import com.uni.project.model.dto.response.NutritionalValueResponse;
import com.uni.project.model.dto.response.UserResponse;
import com.uni.project.model.entity.Sex;

import java.util.List;

public interface UserService {
    UserResponse userCreate(UserRequest userRequest);

    UserResponse getUserById(Integer id);

    List<UserResponse> getAllUsers();

    UserResponse userUpdate(Integer id, UserRequest userRequest);

    void userDelete(Integer id);

    UserResponse measurementsUpdate(Integer id, UserMeasurementsRequest userRequest);

    List<UserResponse> getAllUsersByName(String nameSearch);

    List<UserResponse> getAllUsersBySex(Sex sexSearch);

    List<UserResponse> getAllUsersByAge(Integer ageSearch);

    NutritionalValueResponse calculateNutritionalValueForUser(Integer id);

    List<UserResponse> findAllWithMeals();

    UserResponse createUserWithGoalAndNoteNoTx(UserCompositeRequest userRequest);

    UserResponse createUserWithGoalAndNoteTx(UserCompositeRequest userRequest);
}


Файл MealServiceImpl.java
package com.uni.project.service.impl;

import com.uni.project.exception.MealException;
import com.uni.project.mapper.MealMapper;
import com.uni.project.model.dto.request.MealRequest;
import com.uni.project.model.dto.response.MealResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Product;
import com.uni.project.model.entity.User;
import com.uni.project.repository.MealRepository;
import com.uni.project.repository.UserRepository;
import com.uni.project.service.MealService;
import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

@Service
@AllArgsConstructor
@Transactional(readOnly = true)
public class MealServiceImpl implements MealService {
    private final MealRepository mealRepository;
    private final UserRepository userRepository;

    private final MealMapper mealMapper;

    @Override
    @Transactional
    public MealResponse mealCreate(MealRequest mealRequest) {
        User author = getAuthor(mealRequest.getAuthorId());
        Meal meal = mealRepository
                .save(mealMapper.fromRequest(mealRequest, author));

        return mealMapper.toResponse(meal);
    }

    @Override
    public MealResponse getMealById(Integer id) {
        Meal meal = mealRepository.findById(id)
                .orElseThrow(() -> new MealException("Meal not found bu Id"));

        return mealMapper.toResponse(meal);
    }

    @Override
    public List<MealResponse> getAllMeals() {
        return mealMapper.toResponses(mealRepository.findAll());
    }

    @Override
    @Transactional
    public MealResponse mealUpdate(Integer id, MealRequest mealRequest) {
        Meal meal = mealRepository.findById(id)
                .orElseThrow(() -> new MealException("Meal not found by Id"));
        User author = getAuthor(mealRequest.getAuthorId());
        Meal mappedMeal = mealMapper.fromRequest(mealRequest, author);
        meal.setName(mealRequest.getName());
        meal.setDate(mealRequest.getDate());
        meal.setAuthor(author);
        meal.setTotalNutritional(mappedMeal.getTotalNutritional());
        mealRepository.save(meal);

        return mealMapper.toResponse(meal);
    }

    @Override
    @Transactional
    public void mealDelete(Integer id) {
        Meal meal = mealRepository.findById(id)
                .orElseThrow(() -> new MealException("Meal not found by Id"));

        if (meal.getProductList() != null) {
            for (Product product : new ArrayList<>(meal.getProductList())) {
                if (product.getMealList() != null) {
                    product.getMealList().remove(meal);
                }
            }
            meal.getProductList().clear();
        }

        mealRepository.delete(meal);
    }

    @Override
    public List<MealResponse> getAllMealsByName(String nameSearch) {
        return mealMapper.toResponses(mealRepository.findAllByName(nameSearch));
    }

    @Override
    public List<MealResponse> getAllMealsByAuthorId(Integer authorId) {
        return mealMapper.toResponses(mealRepository.findAllByAuthorId(authorId));
    }

    @Override
    public List<MealResponse> getAllMealsByProductIds(List<Integer> productIds) {
        return mealMapper.toResponses(mealRepository.findAllByProductIds(productIds));
    }

    private User getAuthor(Integer authorId) {
        if (authorId == null) {
            return null;
        }
        return userRepository.findById(authorId)
                .orElseThrow(() -> new MealException("Author not found by Id"));
    }
}


Файл NoteServiceImpl.java
package com.uni.project.service.impl;

import com.uni.project.exception.NoteException;
import com.uni.project.mapper.NoteMapper;
import com.uni.project.model.dto.request.NoteRequest;
import com.uni.project.model.dto.response.NoteResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Note;
import com.uni.project.repository.MealRepository;
import com.uni.project.repository.NoteRepository;
import com.uni.project.service.NoteService;
import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.List;

@Service
@AllArgsConstructor
@Transactional(readOnly = true)
public class NoteServiceImpl implements NoteService {
    private final NoteRepository noteRepository;
    private final MealRepository mealRepository;

    private final NoteMapper noteMapper;

    @Override
    @Transactional
    public NoteResponse noteCreate(NoteRequest noteRequest) {
        Meal meal = getMeal(noteRequest.getMealId());
        if (meal.getRecipe() != null) {
            throw new NoteException("Meal already has a note");
        }

        Note note = noteMapper.fromRequest(noteRequest, meal);
        meal.setRecipe(note);
        Meal savedMeal = mealRepository.save(meal);

        return noteMapper.toResponse(savedMeal.getRecipe());
    }

    @Override
    public NoteResponse getNoteById(Integer id) {
        Note note = noteRepository.findById(id)
                .orElseThrow(() -> new NoteException("Note is not found by Id"));

        return noteMapper.toResponse(note);
    }

    @Override
    public List<NoteResponse> getAllNotes() {
        return noteMapper.toResponses(noteRepository.findAll());
    }

    @Override
    @Transactional
    public NoteResponse noteUpdate(Integer id, NoteRequest noteRequest) {
        Note note = noteRepository.findById(id)
                .orElseThrow(() -> new NoteException("Note is not found by Id"));
        Meal targetMeal = getMeal(noteRequest.getMealId());
        Meal currentMeal = note.getMeal();
        note.setNotes(noteRequest.getNotes());

        if (targetMeal.getRecipe() != null && !targetMeal.getRecipe().getId().equals(note.getId())) {
            throw new NoteException("Target meal already has another note");
        }

        if (currentMeal != null && !currentMeal.getId().equals(targetMeal.getId())) {
            currentMeal.setRecipe(null);
            mealRepository.save(currentMeal);
        }

        note.setMeal(targetMeal);
        targetMeal.setRecipe(note);
        mealRepository.save(targetMeal);

        return noteMapper.toResponse(note);
    }

    @Override
    @Transactional
    public void noteDelete(Integer id) {
        Note note = noteRepository.findById(id)
                .orElseThrow(() -> new NoteException("Note is not found by Id"));
        Meal meal = note.getMeal();
        if (meal == null) {
            noteRepository.delete(note);
            return;
        }

        meal.setRecipe(null);
        mealRepository.save(meal);
    }

    @Override
    public List<NoteResponse> getAllNotesByDate(LocalDate dateSearch) {
        return noteMapper.toResponses(noteRepository.findAllByDate(dateSearch));
    }

    @Override
    public List<NoteResponse> getAllNotesByMealId(Integer mealId) {
        return noteMapper.toResponses(noteRepository.findAllByMealId(mealId));
    }

    private Meal getMeal(Integer mealId) {
        return mealRepository.findById(mealId)
                .orElseThrow(() -> new NoteException("Meal not found by Id"));
    }
}


Файл ProductServiceImpl.java
package com.uni.project.service.impl;

import com.uni.project.exception.ProductException;
import com.uni.project.mapper.ProductMapper;
import com.uni.project.model.dto.request.ProductRequest;
import com.uni.project.model.dto.response.ProductResponse;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Product;
import com.uni.project.repository.MealRepository;
import com.uni.project.repository.ProductRepository;
import com.uni.project.service.ProductService;
import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@AllArgsConstructor
@Transactional(readOnly = true)
public class ProductServiceImpl implements ProductService {
    private final ProductRepository productRepository;
    private final MealRepository mealRepository;

    private final ProductMapper productMapper;

    @Override
    @Transactional
    public ProductResponse productCreate(ProductRequest productRequest) {
        List<Meal> meals = getMeals(productRequest.getMealIds());
        Product product = productRepository
                .save(productMapper.fromRequest(productRequest, meals));

        return productMapper.toResponse(product);
    }

    @Override
    public ProductResponse getProductById(Integer id) {
        Product product = productRepository.findById(id)
                .orElseThrow(() -> new ProductException("Product not found by Id"));

        return productMapper.toResponse(product);
    }

    @Override
    public List<ProductResponse> getAllProducts() {
        return productMapper.toResponses(productRepository.findAll());
    }

    @Override
    @Transactional
    public ProductResponse productUpdate(Integer id, ProductRequest productRequest) {
        Product product = productRepository.findById(id)
                .orElseThrow(() -> new ProductException("Product not found by Id"));
        List<Meal> meals = getMeals(productRequest.getMealIds());
        Product mappedProduct = productMapper.fromRequest(productRequest, meals);
        product.setName(productRequest.getName());
        product.setNutritionalValue100g(mappedProduct.getNutritionalValue100g());
        product.setMealList(meals);
        productRepository.save(product);

        return productMapper.toResponse(product);
    }

    @Override
    @Transactional
    public void productDelete(Integer id) {
        Product product = productRepository.findById(id)
                .orElseThrow(() -> new ProductException("Product not found by Id"));

        if (product.getMealList() != null) {
            product.getMealList().clear();
        }

        if (product.getNutritionalValue100g() != null) {
            product.setNutritionalValue100g(null);
        }

        productRepository.save(product);
        productRepository.delete(product);
    }

    @Override
    public List<ProductResponse> getAllProductsByName(String nameSearch) {
        return productMapper.toResponses(productRepository.findAllByName(nameSearch));
    }

    @Override
    public List<ProductResponse> getAllProductsByMealId(Integer mealId) {
        return productMapper.toResponses(productRepository.findAllByMealId(mealId));
    }

    private List<Meal> getMeals(List<Integer> mealIds) {
        if (mealIds == null || mealIds.isEmpty()) {
            return List.of();
        }
        List<Meal> meals = mealRepository.findAllById(mealIds);
        if (meals.size() != mealIds.size()) {
            throw new ProductException("Some meals not found");
        }
        return meals;
    }
}


Файл UserServiceImpl.java
package com.uni.project.service.impl;

import com.uni.project.exception.UserException;
import com.uni.project.mapper.NutritionalValueMapper;
import com.uni.project.mapper.UserMapper;
import com.uni.project.model.dto.request.UserCompositeRequest;
import com.uni.project.model.dto.request.UserMeasurementsRequest;
import com.uni.project.model.dto.request.UserRequest;
import com.uni.project.model.dto.response.NutritionalValueResponse;
import com.uni.project.model.dto.response.UserResponse;
import com.uni.project.model.entity.BodyParameters;
import com.uni.project.model.entity.Meal;
import com.uni.project.model.entity.Note;
import com.uni.project.model.entity.NutritionalValue;
import com.uni.project.model.entity.Sex;
import com.uni.project.model.entity.User;
import com.uni.project.repository.MealRepository;
import com.uni.project.repository.UserRepository;
import com.uni.project.service.UserService;
import java.util.ArrayList;
import java.util.List;
import lombok.AllArgsConstructor;
import org.jspecify.annotations.NonNull;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

@Service
@AllArgsConstructor
@Transactional(readOnly = true)
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;
    private final MealRepository mealRepository;
    private final UserMapper userMapper;
    private final NutritionalValueMapper nutritionalValueMapper;
    private static final String USER_FAIL_MESSAGE = "User not found by Id";

    @Override
    @Transactional
    public UserResponse userCreate(UserRequest userRequest) {
        User user = userMapper.fromRequest(userRequest);
        user.setMealsPlan(new ArrayList<>());
        user = userRepository.save(user);
        return userMapper.toResponse(user);
    }

    @Override
    public UserResponse getUserById(Integer id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new UserException(USER_FAIL_MESSAGE));
        return userMapper.toResponse(user);
    }

    @Override
    public List<UserResponse> getAllUsers() {
        return userMapper.toResponses(userRepository.findAll());
    }

    @Override
    @Transactional
    public UserResponse userUpdate(Integer id, UserRequest userRequest) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new UserException(USER_FAIL_MESSAGE));
        user.setName(userRequest.getName());
        user.setPassword(userRequest.getPassword());
        user.setEmail(userRequest.getEmail());
        user.setMeasurements(userRequest.getMeasurements());
        if (userRequest.getDailyGoal() != null) {
            user.setDailyGoal(nutritionalValueMapper.fromRequest(userRequest.getDailyGoal()));
        }

        userRepository.save(user);
        return userMapper.toResponse(user);
    }

    @Override
    @Transactional
    public void userDelete(Integer id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new UserException(USER_FAIL_MESSAGE));
        userRepository.delete(user);
    }

    @Override
    @Transactional
    public UserResponse measurementsUpdate(Integer id, UserMeasurementsRequest userRequest) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new UserException(USER_FAIL_MESSAGE));
        user.setMeasurements(userRequest.getMeasurements());
        userRepository.save(user);
        return userMapper.toResponse(user);
    }

    @Override
    public List<UserResponse> getAllUsersByName(String nameSearch) {
        return userMapper.toResponses(userRepository.findAllByName(nameSearch));
    }

    @Override
    public List<UserResponse> getAllUsersBySex(Sex sexSearch) {
        return userMapper.toResponses(userRepository.findAllBySex(sexSearch));
    }

    @Override
    public List<UserResponse> getAllUsersByAge(Integer ageSearch) {
        return userMapper.toResponses(userRepository.findAllByAge(ageSearch));
    }

    @Override
    @Transactional(readOnly = true)
    public NutritionalValueResponse calculateNutritionalValueForUser(Integer idUser) {
        User user = userRepository.findById(idUser).
                orElseThrow(() -> new UserException(USER_FAIL_MESSAGE));
        BodyParameters measurements = user.getMeasurements();
        if (measurements == null
                || measurements.getWeight() == null
                || measurements.getHeight() == null
                || measurements.getAge() == null
                || measurements.getSex() == null) {
            throw new UserException("User measurements are incomplete for nutritional value calculation");
        }
        NutritionalValue goalNutritionalValue = getNutritionalValue(measurements);
        user.setDailyGoal(goalNutritionalValue);
        userRepository.save(user);

        return nutritionalValueMapper.toResponse(goalNutritionalValue);
    }

    @NonNull
    private static NutritionalValue getNutritionalValue(BodyParameters measurements) {
        NutritionalValue goalNutritionalValue = new NutritionalValue();
        double baseValues = (measurements.getWeight() * 10
                + measurements.getHeight() * 6.25
                - measurements.getAge() * 5);
        baseValues = (measurements.getSex() == Sex.FEMALE)
                ? (baseValues - 161)
                : (baseValues + 5);
        goalNutritionalValue.setCalories(baseValues);
        goalNutritionalValue.setProteins(baseValues * 0.25);
        goalNutritionalValue.setFats(baseValues * 0.2);
        goalNutritionalValue.setCarbohydrates(baseValues * 0.55);
        return goalNutritionalValue;
    }

    @Override
    public List<UserResponse> findAllWithMeals() {
        List<User> userList = userRepository.findAllWithMeals();
        return userMapper.toResponses(userList);
    }

    @Override
    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public UserResponse createUserWithGoalAndNoteNoTx(UserCompositeRequest userRequest) {
        return createCompositeInternal(userRequest);
    }

    @Override
    @Transactional
    public UserResponse createUserWithGoalAndNoteTx(UserCompositeRequest userRequest) {
        return createCompositeInternal(userRequest);
    }

    private UserResponse createCompositeInternal(UserCompositeRequest request) {
        if (request.getDailyGoal() == null) {
            throw new UserException("Daily goal is required");
        }
        NutritionalValue dailyGoal = nutritionalValueMapper.fromRequest(request.getDailyGoal());
        User user = userMapper.fromRequest(request);
        user.setDailyGoal(dailyGoal);
        user.setMealsPlan(new ArrayList<>());
        user = userRepository.save(user);

        if (request.isFailAfterUser()) {
            throw new UserException("Forced error after saving user and daily goal");
        }

        Note note = new Note();
        note.setNotes(request.getNoteTexts());

        Meal meal = new Meal();
        meal.setName("Meal note");
        meal.setDate(request.getNoteDate());
        meal.setAuthor(user);
        meal.setRecipe(note);
        mealRepository.save(meal);
        if (user.getMealsPlan() != null) {
            user.getMealsPlan().add(meal);
        }

        return userMapper.toResponse(user);
    }
}


Файл ProjectApplicationTests.java
package com.uni.project;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;

@Import(TestcontainersConfiguration.class)
@SpringBootTest
class ProjectApplicationTests {

	@Test
	void contextLoads() {
	}

}


Файл TestProjectApplication.java
package com.uni.project;

import org.springframework.boot.SpringApplication;

public class TestProjectApplication {

	public static void main(String[] args) {
		SpringApplication.from(ProjectApplication::main).with(TestcontainersConfiguration.class).run(args);
	}

}


Файл TestcontainersConfiguration.java
package com.uni.project;

import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.boot.testcontainers.service.connection.ServiceConnection;
import org.springframework.context.annotation.Bean;
import org.testcontainers.postgresql.PostgreSQLContainer;
import org.testcontainers.utility.DockerImageName;

@TestConfiguration(proxyBeanMethods = false)
class TestcontainersConfiguration {

	@Bean
	@ServiceConnection
	PostgreSQLContainer postgresContainer() {
		return new PostgreSQLContainer(DockerImageName.parse("postgres:latest"));
	}

}


